name: Release to GHCR

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/iangreen74/leviathan

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      run: |
        # Get short SHA
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
        # Determine if this is a tag push
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          echo "is_tag=true" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        else
          echo "is_tag=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Build and push control-plane image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ops/docker/control-plane.Dockerfile
        push: true
        tags: |
          ${{ env.IMAGE_PREFIX }}-control-plane:${{ steps.meta.outputs.short_sha }}
          ${{ steps.meta.outputs.is_tag == 'true' && format('{0}-control-plane:{1}', env.IMAGE_PREFIX, steps.meta.outputs.version) || '' }}
          ${{ steps.meta.outputs.is_tag == 'true' && format('{0}-control-plane:latest', env.IMAGE_PREFIX) || '' }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push worker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ops/docker/worker.Dockerfile
        push: true
        tags: |
          ${{ env.IMAGE_PREFIX }}-worker:${{ steps.meta.outputs.short_sha }}
          ${{ steps.meta.outputs.is_tag == 'true' && format('{0}-worker:{1}', env.IMAGE_PREFIX, steps.meta.outputs.version) || '' }}
          ${{ steps.meta.outputs.is_tag == 'true' && format('{0}-worker:latest', env.IMAGE_PREFIX) || '' }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Output image tags
      run: |
        echo "Published images:"
        echo "  Control Plane: ${{ env.IMAGE_PREFIX }}-control-plane:${{ steps.meta.outputs.short_sha }}"
        echo "  Worker: ${{ env.IMAGE_PREFIX }}-worker:${{ steps.meta.outputs.short_sha }}"
        if [[ "${{ steps.meta.outputs.is_tag }}" == "true" ]]; then
          echo "  Control Plane: ${{ env.IMAGE_PREFIX }}-control-plane:${{ steps.meta.outputs.version }}"
          echo "  Worker: ${{ env.IMAGE_PREFIX }}-worker:${{ steps.meta.outputs.version }}"
          echo "  Control Plane: ${{ env.IMAGE_PREFIX }}-control-plane:latest"
          echo "  Worker: ${{ env.IMAGE_PREFIX }}-worker:latest"
        fi
